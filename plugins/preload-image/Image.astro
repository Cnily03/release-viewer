---
import type { HTMLAttributes } from "astro/types";
import { downloadAndCacheImage } from "./utils";

export interface Props extends HTMLAttributes<"img"> {
  src?: string;
}

const { src, ...rest } = Astro.props;

let finalSrc = src;

if (src && process.env.NODE_ENV === "production" && /https?:\/\/.+/.test(src)) {
  finalSrc = await downloadAndCacheImage(src);
}
---

<img src={finalSrc} {...rest} />
